<p-toast />
<p-confirm-dialog />
<div class="user-table-container">
  <p-table
    stripedRows
    [value]="filteredUsers()"
  >

    <ng-template #caption>
      <div class="search">
        <h2>{{ strings.USERS }}</h2>
        <div>
          <p-button
            icon="pi pi-filter-slash"
            label="{{ strings.CLEAR }}"
            [outlined]="true"
            (onClick)="searchControl.setValue('')"
          />
          <input
            pInputText
            type="text"
            placeholder="{{ strings.SEARCH_PLACEHOLDER }}"
            [formControl]="searchControl"
          />

          @if(isAdmin){
          <p-button
            icon="pi pi-plus"
            (onClick)="addUserVisible=true"
          />
          <p-dialog
            [(visible)]="addUserVisible"
            [modal]="true"
          >
            <ng-template #header>
              <h2>{{ strings.ADD_USER }}</h2>
            </ng-template>
            <app-add
              (userAdded)="onUserAdded($event)"
              (cancelled)="addUserVisible=false"
            ></app-add>
          </p-dialog>
          }
        </div>
      </div>
    </ng-template>

    <ng-template #header>
      <tr>
        <th pSortableColumn="email">
          {{ strings.EMAIL }}
          <p-sortIcon field="email" />
        </th>
        <th pSortableColumn="name">
          {{ strings.NAME }}
          <p-sortIcon field="name" />
        </th>
        <th pSortableColumn="role">
          {{ strings.ROLE }}
          <p-sortIcon field="role" />
        </th>
        <th>{{ strings.ACTIONS }}</th>
      </tr>
    </ng-template>
    <ng-template
      #body
      let-user
    >
      <tr>
        <td>{{ user.email }}</td>
        <td>{{ user.name | titlecase}}</td>
        <td>{{ user.role }}</td>
        <td class="actions-column">
          <p-button
            pButton
            type="button"
            icon="pi pi-pencil"
            [disabled]="!allowedRoles.includes(user.role)"
            (onClick)="openEditDialog(user)"
          />
          @if(isAdmin){
          <p-button
            pButton
            type="button"
            icon="pi pi-trash"
            severity="danger"
            [disabled]="user.role=='Admin'"
            (onClick)="deleteUser(user.email)"
          />
          }
        </td>
      </tr>

    </ng-template>
  </p-table>

  @if(selectedUser) {
  <p-dialog
    (onHide)="closeEditDialog()"
    [(visible)]="editVisible"
    [modal]="true"
  >
    <ng-template #header>
      <h2>{{ strings.EDIT_USER }}</h2>
    </ng-template>
    <app-edit
      [user]="selectedUser"
      (userUpdated)="onUserUpdated()"
      (cancelled)="closeEditDialog()"
    />
  </p-dialog>
  }
</div>